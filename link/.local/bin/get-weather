#!/usr/bin/bash
# SPDX-FileCopyrightText: Steven Ward
# SPDX-License-Identifier: OSL-3.0

if [[ -z "$LAT" ]] || [[ -z "$LON" ]]
then
	declare -r IP_URI='http://ip-api.com/line/?fields=lat,lon'

	mapfile -t MY_LOCATION < <(curl -s -f "$IP_URI") || exit
	LAT="${MY_LOCATION[0]}"
	LON="${MY_LOCATION[1]}"
	unset MY_LOCATION
fi

# https://openweathermap.org/current#data
# Possible values: standard, metric, imperial
declare -r UNITS=imperial

declare -r WEATHER_JSON="$XDG_RUNTIME_DIR"/weather.json

if [[ ! -f "$WEATHER_JSON" ]] || (( $(date -r "$WEATHER_JSON" +%s) < $(date -d '10 minutes ago' +%s) ))
then
	if [[ -z "$OPENWEATHERMAP_API_KEY" ]]
	then
		echo 'Error: Must have OpenWeather API key'
		echo 'https://openweathermap.org/api'
		exit 1
	fi

	declare -r WEATHER_URI="https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=${UNITS}&appid=${OPENWEATHERMAP_API_KEY}"

	curl -s -f "$WEATHER_URI" > "$WEATHER_JSON" || exit
fi

mapfile -t WEATHER_FIELDS < <(jq -r '
.weather[0].main,
.weather[0].description,
.main.temp,
.main.feels_like,
.main.pressure,
.main.humidity,
.main.temp_min,
.main.temp_max,
.wind.speed,
.wind.deg,
.clouds.all,
.dt,
.sys.sunrise,
.sys.sunset' < "$WEATHER_JSON")

MAIN="${WEATHER_FIELDS[0]}"
DESCRIPTION="${WEATHER_FIELDS[1]}"
TEMP="${WEATHER_FIELDS[2]}"
FEELS_LIKE="${WEATHER_FIELDS[3]}"
PRESSURE="${WEATHER_FIELDS[4]}"
HUMIDITY="${WEATHER_FIELDS[5]}"
TEMP_MIN="${WEATHER_FIELDS[6]}"
TEMP_MAX="${WEATHER_FIELDS[7]}"
WIND_SPEED="${WEATHER_FIELDS[8]}"
WIND_DIR="${WEATHER_FIELDS[9]}"
CLOUDINESS="${WEATHER_FIELDS[10]}"
DT="${WEATHER_FIELDS[11]}"
SUNRISE="${WEATHER_FIELDS[12]}"
SUNSET="${WEATHER_FIELDS[13]}"

# https://www.weather.gov/pqr/wind
declare -r MIN_WIND_SPEED='3.5'

if (( $(bc -q <<< "$WIND_SPEED >= $MIN_WIND_SPEED") == 1 ))
then
	if command -v wind-dir > /dev/null
	then
		WIND_DIR="$(wind-dir <<< "$WIND_DIR")" || exit
	else
		WIND_DIR+='°'
	fi
else
	WIND_DIR=''
fi

DT=$(date --date="@$DT" +'%FT%T')
SUNRISE=$(date --date="@$SUNRISE" +'%H:%M')
SUNSET=$(date --date="@$SUNSET" +'%H:%M')

[[ -n "$MAIN" && -n "$DESCRIPTION"  ]] && printf '%s (%s)' "$MAIN" "$DESCRIPTION"
[[ -n "$TEMP"                       ]] && printf '  %.0f°F' "$TEMP"
[[ -n "$FEELS_LIKE"                 ]] && printf ' (feels like %.0f°F)' "$FEELS_LIKE"
[[ -n "$TEMP_MIN" && -n "$TEMP_MAX" ]] && printf ' [%.0f°F, %.0f°F]' "$TEMP_MIN" "$TEMP_MAX"
[[ -n "$HUMIDITY"                   ]] && printf '  %d%% humid' "$HUMIDITY"
[[ -n "$WIND_SPEED"                 ]] && printf '  %.0f mph' "$WIND_SPEED"
[[ -n "$WIND_DIR"                   ]] && printf ' %s' "$WIND_DIR"
[[ -n "$CLOUDINESS"                 ]] && printf '  %d%% cloudy' "$CLOUDINESS"
[[ -n "$PRESSURE"                   ]] && printf '  %d hPa' "$PRESSURE"
[[ -n "$SUNRISE"                    ]] && printf '  %s▵̲' "$SUNRISE"
[[ -n "$SUNSET"                     ]] && printf ' %s▿̲' "$SUNSET"
[[ -n "$DT"                         ]] && printf '  (%s)' "$DT"
printf '\n'
